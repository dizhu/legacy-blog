<!DOCTYPE html>
<html lang=zh>
<head><meta name="generator" content="Hexo 3.8.0">
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="description" content="引昨天接到朋友的一个电话，说服务器被攻击了。上去一看，Windows 主机弱密码，直接被远程登录中了勒索病毒，要价就是好几十比特币。所有文件都被加密。遇到这个问题，第一反应就是完蛋，直接恢复备份吧。然而这是台物理机，而不是云主机，备份没有那么方便，所以这台机器 没有备份。 这基本上已经基本判了死刑了，当时的解决是立刻切断服务器电源，挂载到安全的电脑上找一些还没来得及被加密的文件抢救。 初探由于朋友">
<meta name="keywords" content="编程,Ruby,运维,MySQL">
<meta property="og:type" content="article">
<meta property="og:title" content="MySQL 惊险恢复记">
<meta property="og:url" content="https://coderemixer.com/2018/01/05/mysql-recover-from-general/index.html">
<meta property="og:site_name" content="代码混音师">
<meta property="og:description" content="引昨天接到朋友的一个电话，说服务器被攻击了。上去一看，Windows 主机弱密码，直接被远程登录中了勒索病毒，要价就是好几十比特币。所有文件都被加密。遇到这个问题，第一反应就是完蛋，直接恢复备份吧。然而这是台物理机，而不是云主机，备份没有那么方便，所以这台机器 没有备份。 这基本上已经基本判了死刑了，当时的解决是立刻切断服务器电源，挂载到安全的电脑上找一些还没来得及被加密的文件抢救。 初探由于朋友">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2018-10-21T12:54:32.098Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="MySQL 惊险恢复记">
<meta name="twitter:description" content="引昨天接到朋友的一个电话，说服务器被攻击了。上去一看，Windows 主机弱密码，直接被远程登录中了勒索病毒，要价就是好几十比特币。所有文件都被加密。遇到这个问题，第一反应就是完蛋，直接恢复备份吧。然而这是台物理机，而不是云主机，备份没有那么方便，所以这台机器 没有备份。 这基本上已经基本判了死刑了，当时的解决是立刻切断服务器电源，挂载到安全的电脑上找一些还没来得及被加密的文件抢救。 初探由于朋友">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>MySQL 惊险恢复记</title>
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- persian styles -->
    
      <link rel="stylesheet" href="/css/rtl.css">
    
    <!-- rss -->
    
    
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="/about/">关于</a></li>
         
          <li><a href="/archives/">归档</a></li>
         
          <li><a href="https://github.com/dsh0416">项目</a></li>
         
          <li><a href="/atom.xml">RSS</a></li>
        
      </ul>
    </span>
    <br>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2018/06/06/coding-tutorial/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2017/12/26/rack-rails-user-ip-bug/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">上一篇</span>
      <span id="i-next" class="info" style="display:none;">下一篇</span>
      <span id="i-top" class="info" style="display:none;">返回顶部</span>
      <span id="i-share" class="info" style="display:none;">分享文章</span>
    </span>
    <br>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://coderemixer.com/2018/01/05/mysql-recover-from-general/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://coderemixer.com/2018/01/05/mysql-recover-from-general/&text=MySQL 惊险恢复记"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://coderemixer.com/2018/01/05/mysql-recover-from-general/&title=MySQL 惊险恢复记"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://coderemixer.com/2018/01/05/mysql-recover-from-general/&is_video=false&description=MySQL 惊险恢复记"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=MySQL 惊险恢复记&body=Check out this article: https://coderemixer.com/2018/01/05/mysql-recover-from-general/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://coderemixer.com/2018/01/05/mysql-recover-from-general/&title=MySQL 惊险恢复记"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://coderemixer.com/2018/01/05/mysql-recover-from-general/&title=MySQL 惊险恢复记"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://coderemixer.com/2018/01/05/mysql-recover-from-general/&title=MySQL 惊险恢复记"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://coderemixer.com/2018/01/05/mysql-recover-from-general/&title=MySQL 惊险恢复记"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://coderemixer.com/2018/01/05/mysql-recover-from-general/&name=MySQL 惊险恢复记&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#引"><span class="toc-number">1.</span> <span class="toc-text">引</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#初探"><span class="toc-number">2.</span> <span class="toc-text">初探</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#转机"><span class="toc-number">3.</span> <span class="toc-text">转机</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Oh-General-My-General"><span class="toc-number">4.</span> <span class="toc-text">Oh General! My General!</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#结"><span class="toc-number">5.</span> <span class="toc-text">结</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope="" itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        MySQL 惊险恢复记
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
        <span itemprop="name">代码混音师</span>
      </span>
      
    <div class="postdate">
        <time datetime="2018-01-05T12:48:59.000Z" itemprop="datePublished">2018-01-05</time>
    </div>


      

      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link" href="/tags/MySQL/">MySQL</a>, <a class="tag-link" href="/tags/Ruby/">Ruby</a>, <a class="tag-link" href="/tags/编程/">编程</a>, <a class="tag-link" href="/tags/运维/">运维</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h2 id="引"><a href="#引" class="headerlink" title="引"></a>引</h2><p>昨天接到朋友的一个电话，说服务器被攻击了。上去一看，Windows 主机弱密码，直接被远程登录中了勒索病毒，要价就是好几十比特币。所有文件都被加密。遇到这个问题，第一反应就是完蛋，直接恢复备份吧。然而这是台物理机，而不是云主机，备份没有那么方便，所以这台机器</p>
<p><strong>没有备份。</strong></p>
<p>这基本上已经基本判了死刑了，当时的解决是立刻切断服务器电源，挂载到安全的电脑上找一些还没来得及被加密的文件抢救。</p>
<h2 id="初探"><a href="#初探" class="headerlink" title="初探"></a>初探</h2><p>由于朋友当时不知道怎么拆 RAID 阵列，所以就直接把服务器整机搬到了我家里。🤦‍</p>
<p>不过后来我拆开一看，其实只是一个 RAID 1，所以任何一块盘的内容是一样的，随便拔一块下来。联想收购 ThinkServer 后干的最大的大好事就是把硬盘架上的 T6H 螺丝换成了标准的十字螺丝。（我之前在 ThinkServer 螺丝问题上的坑爹遭遇参考<a href="/2017/02/14/build-up-x79-workstation/">此贴</a>）</p>
<p>SATA 连上电脑检查文件。硬盘的核心文件是一个 MySQL 数据库，其它文件都是 stateless 的代码，倒是很容易恢复。根据恢复 MySQL 数据库的经验，第一反应是去找 MySQL 二进制日志文件。许多数据灾难最后都是通过二进制日志恢复的，而且这些已经都有非常成熟的工具可以直接使用。</p>
<p>然而找到 <code>log</code> 的目录的时候发现所有的 <code>.bin</code> 文件已经变成了 <code>.bin.RESERVE</code>，显然是已经被加密没救了。</p>
<h2 id="转机"><a href="#转机" class="headerlink" title="转机"></a>转机</h2><p>然而接下来，我突然发现，这个病毒的实现有个 Bug，一个实实在在的 Bug，为这个事情发现了转机。病毒没有加密所有文件，因为如果这样，它也无法发送自己的勒索信息，所以它保留了其自己生成出来文件名的文件不被加密。然而为了方便判断这个「自己生成」的概念，病毒是直接依靠后缀的。病毒保留了 <code>.html</code> <code>.txt</code> 和 <code>.log</code> 后缀的所有文件。</p>
<p><code>.log</code>？这个通用的日志格式不也是 MySQL General Query Log 用的吗？虽然一般情况下，我们不会打开 MySQL General Query Log 这个那么低级别的 Log，<strong>但是</strong> 这台机器完全是一群不懂运维的人维护的。所有 MySQL 竟然是用 WAMP 全家桶安装的，还真的默认开启了 MySQL General Query Log。把 <code>mysql.log</code> 文件 dump 下来，果然完整叙述了这台机器运行一年间所有的连接和查询信息。依靠这个看来可以把所有数据都还原了！</p>
<h2 id="Oh-General-My-General"><a href="#Oh-General-My-General" class="headerlink" title="Oh General! My General!"></a>Oh General! My General!</h2><p>MySQL General Query Log 虽然信息全，但并没有好用的直接把数据倒回去的工具（毕竟会开这个选项的可能性就很小吧）。那么没有就自己写咯。</p>
<p>简单写了个 MySQL General Query Log 恢复工具：<a href="https://github.com/dsh0416/my-general" target="_blank" rel="noopener">my_general</a></p>
<p>这个工具的原理很简单，就是 parse log，然后判断这一行是不是一个 QUERY。然后简单判断了一下这个 QUERY 是不是一个 <code>SELECT</code> 或者 <code>SHOW</code>。如果是，就直接跳过；如果不是，那么就在数据库上运行一下。</p>
<p>然而这个还是有一些问题，有一些 QUERY 是在 <code>DATABASE</code> 层做的，有些是连接上具体 <code>DATABASE</code> 进行的。但是由于问题比较简单，我就先手动建立 <code>DATABASE</code>，然后过滤所有 <code>CREATE DATABASE</code> 和 <code>CREATE USER</code> 的操作。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&gt; gem install my_general</span><br><span class="line">&gt; my_general -l mysql.log -d connection.yaml</span><br><span class="line"></span><br><span class="line">Log File:           mysql.log</span><br><span class="line">Database YAML:      connection.yml</span><br><span class="line">[1/4] ⌚  Counting Complexity...</span><br><span class="line">[1/4] ⌚  Counting Complexity... OK [Complexity: 17793561]</span><br><span class="line">[2/4] 🔌  Dailing Database...</span><br><span class="line">[2/4] 🔌  Dailing Database... OK [Connected]</span><br><span class="line">[3/4] ⏳  Importing Data...</span><br><span class="line">Progress: |=====================================================================|</span><br><span class="line">[3/4] ⏳  Importing Data... OK [17793561/17793561]</span><br><span class="line">[4/4] 🚩  Finished!</span><br></pre></td></tr></table></figure>
<p>解决！</p>
<p>不过这玩意有一些问题，因为分隔符是换行号，如果主动比如在 <code>CREATE TABLE</code> 的时候自己拼一些换行号可能会爆炸。如果是用 ORM 做的 Migration 和日常使用，倒是没有这种特殊符号的问题。</p>
<h2 id="结"><a href="#结" class="headerlink" title="结"></a>结</h2><p>做备份啊，做备份。备份不到用的时候永远被低估，一旦用到就悔恨万分。</p>
<p>保持良好的用机习惯，不要没事上服务器下片。这服务器上连天猫、淘宝的浏览记录都有，还把 IE 的安全级别调低了。</p>
<p>还有就是，遇到这种非常规的问题，不能紧张，保持乐观，要仔细寻找线索。</p>
<p>反正修不好是常态，万一修好了呢。（逃</p>

  </div>
</article>

    <div class="blog-post-comments">
        <div id="disqus_thread">
            <noscript>加载评论需要在浏览器启用 JavaScript 脚本支持。</noscript>
        </div>
    </div>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="/about/">关于</a></li>
         
          <li><a href="/archives/">归档</a></li>
         
          <li><a href="https://github.com/dsh0416">项目</a></li>
         
          <li><a href="/atom.xml">RSS</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#引"><span class="toc-number">1.</span> <span class="toc-text">引</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#初探"><span class="toc-number">2.</span> <span class="toc-text">初探</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#转机"><span class="toc-number">3.</span> <span class="toc-text">转机</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Oh-General-My-General"><span class="toc-number">4.</span> <span class="toc-text">Oh General! My General!</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#结"><span class="toc-number">5.</span> <span class="toc-text">结</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://coderemixer.com/2018/01/05/mysql-recover-from-general/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://coderemixer.com/2018/01/05/mysql-recover-from-general/&text=MySQL 惊险恢复记"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://coderemixer.com/2018/01/05/mysql-recover-from-general/&title=MySQL 惊险恢复记"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://coderemixer.com/2018/01/05/mysql-recover-from-general/&is_video=false&description=MySQL 惊险恢复记"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=MySQL 惊险恢复记&body=Check out this article: https://coderemixer.com/2018/01/05/mysql-recover-from-general/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://coderemixer.com/2018/01/05/mysql-recover-from-general/&title=MySQL 惊险恢复记"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://coderemixer.com/2018/01/05/mysql-recover-from-general/&title=MySQL 惊险恢复记"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://coderemixer.com/2018/01/05/mysql-recover-from-general/&title=MySQL 惊险恢复记"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://coderemixer.com/2018/01/05/mysql-recover-from-general/&title=MySQL 惊险恢复记"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://coderemixer.com/2018/01/05/mysql-recover-from-general/&name=MySQL 惊险恢复记&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> 菜单</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> 目录</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> 分享</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> 返回顶部</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2018 CodeRemixer
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="/about/">关于</a></li>
         
          <li><a href="/archives/">归档</a></li>
         
          <li><a href="https://github.com/dsh0416">项目</a></li>
         
          <li><a href="/atom.xml">RSS</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
</body>
</html>
<!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">

<!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>
<script src="/js/main.js"></script>
<!-- search -->

<!-- Google Analytics -->

    <script type="text/javascript">
        (function(i,s,o,g,r,a,m) {i['GoogleAnalyticsObject']=r;i[r]=i[r]||function() {
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-127825283-1', 'auto');
        ga('send', 'pageview');
    </script>

<!-- Baidu Analytics -->

<!-- Disqus Comments -->

    <script type="text/javascript">
        var disqus_shortname = 'coderemixer';

        (function(){
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        }());
    </script>


<!-- MathJax -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"] ],
        processEscapes: true
      }
    });
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script>

<!-- Adsense -->
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
  (adsbygoogle = window.adsbygoogle || []).push({
    google_ad_client: "ca-pub-5302383111484719",
    enable_page_level_ads: true
  });
</script>

